@using LinqStudio.Abstractions.Models
@using LinqStudio.Core.Services
@inject IDialogService DialogService
@inject ConnectionService ConnectionService
@inject ISnackbar Snackbar
@inject ErrorHandlingService ErrorHandlingService

<MudDialog>
	<TitleContent>
		<MudText Typo="Typo.h6">
			<MudIcon Icon="@Icons.Material.Filled.Cable" Class="mr-3" />
			@SharedResource.ConnectionSettings_Title
		</MudText>
	</TitleContent>
	<DialogContent>
		<MudStack Spacing="3">
			<MudSelect T="DatabaseType" 
					   @bind-Value="_databaseType" 
					   Label="@SharedResource.ConnectionSettings_DatabaseType"
					   Variant="Variant.Outlined"
					   Disabled="_isTesting"
					   data-testid="database-type-select">
				@foreach (DatabaseType dbType in Enum.GetValues(typeof(DatabaseType)))
				{
					<MudSelectItem T="DatabaseType" Value="@dbType">@dbType.ToString()</MudSelectItem>
				}
			</MudSelect>

			<MudTextField T="string"
						  @bind-Value="_connectionString"
						  Label="@SharedResource.ConnectionSettings_ConnectionString"
						  Variant="Variant.Outlined"
						  Lines="5"
						  Disabled="_isTesting"
						  data-testid="connection-string-input" />

			<MudSelect T="int" 
					   @bind-Value="_timeoutSeconds" 
					   Label="@SharedResource.ConnectionSettings_Timeout"
					   Variant="Variant.Outlined"
					   Disabled="_isTesting"
					   data-testid="timeout-select">
				<MudSelectItem T="int" Value="5">5s</MudSelectItem>
				<MudSelectItem T="int" Value="10">10s</MudSelectItem>
				<MudSelectItem T="int" Value="15">15s</MudSelectItem>
				<MudSelectItem T="int" Value="30">30s</MudSelectItem>
				<MudSelectItem T="int" Value="60">60s</MudSelectItem>
			</MudSelect>
		</MudStack>
	</DialogContent>
	<DialogActions>
		<MudButton OnClick="ValidateConnection" 
				   Variant="Variant.Outlined" 
				   Color="Color.Info"
				   Disabled="_isTesting"
				   data-testid="validate-button">
			@if (_isTesting)
			{
				<MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
				<span>@SharedResource.ConnectionSettings_Message_Testing</span>
			}
			else
			{
				<span>@SharedResource.ConnectionSettings_Button_Validate</span>
			}
		</MudButton>
		<MudSpacer />
		<MudButton OnClick="Close" 
				   Variant="Variant.Outlined"
				   Disabled="_isTesting"
				   data-testid="close-button">
			@SharedResource.ConnectionSettings_Button_Close
		</MudButton>
		<MudButton OnClick="Save" 
				   Variant="Variant.Filled" 
				   Color="Color.Primary"
				   Disabled="_isTesting"
				   data-testid="save-button">
			@SharedResource.ConnectionSettings_Button_Save
		</MudButton>
	</DialogActions>
</MudDialog>

@code {
	[CascadingParameter]
	private IMudDialogInstance? MudDialog { get; set; }

	private DatabaseType _databaseType = DatabaseType.Mssql;
	private string _connectionString = string.Empty;
	private string _initialConnectionString = string.Empty;
	private int _timeoutSeconds = 10;
	private bool _isTesting = false;

	protected override void OnInitialized()
	{
		base.OnInitialized();
		// Load current connection string from service
		_connectionString = ConnectionService.ConnectionString ?? string.Empty;
		_initialConnectionString = _connectionString;
	}

	private bool HasChanges => _connectionString != _initialConnectionString;

	private async Task ValidateConnection()
	{
		if (string.IsNullOrWhiteSpace(_connectionString))
		{
			Snackbar.Add(SharedResource.ConnectionSettings_Message_ValidationFailed, Severity.Error);
			return;
		}

		_isTesting = true;
		StateHasChanged();

		try
		{
			await ConnectionService.TestConnectionAsync(_databaseType, _connectionString, _timeoutSeconds);
			Snackbar.Add(SharedResource.ConnectionSettings_Message_ValidationSuccess, Severity.Success);
		}
		catch (OperationCanceledException)
		{
			Snackbar.Add(SharedResource.ConnectionSettings_Message_ValidationFailed + " (Timeout)", Severity.Error);
		}
		catch (Exception ex)
		{
			await ErrorHandlingService.HandleErrorAsync(ex, SharedResource.ConnectionSettings_Message_ValidationFailed);
		}
		finally
		{
			_isTesting = false;
			StateHasChanged();
		}
	}

	private void Save()
	{
		// Save to the singleton service
		ConnectionService.UpdateConnection(_databaseType, _connectionString);

		_initialConnectionString = _connectionString;
		Snackbar.Add(SharedResource.ConnectionSettings_Message_Saved, Severity.Success);
		MudDialog?.Close();
	}

	private async Task Close()
	{
		if (HasChanges)
		{
			var result = await DialogService.ShowMessageBox(
				SharedResource.ConnectionSettings_Message_UnsavedChangesTitle,
				SharedResource.ConnectionSettings_Message_UnsavedChanges,
				yesText: SharedResource.Global_MessageBox_Yes,
				noText: SharedResource.Global_MessageBox_No);

			if (result != true)
			{
				return; // User chose not to close
			}
		}

		MudDialog?.Close();
	}
}
